<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script src="/js/jquery-1.9.1.min.js"></script>
<link rel="stylesheet" href="/js/layui/css/layui.css"/>
<link rel="stylesheet" href="/js/layui/css/modules/laydate/default/laydate.css"/>
<link rel="stylesheet" href="/js/layui/css/layui.css"  media="all"/>
<script type="text/javascript" src="/js/layui/layui.js"></script>
<script src="/js/layui/layui.all.js" charset="UTF-8"></script>
<script src="/js/layui/lay/modules/tree.js"></script>
<body>
<center><font color="black" size="7px">优惠券</font></center>
<table class="layui-hide" id="demo" lay-filter="test"></table>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<style>
    .picurl{  /*最后的pic为字段的field*/
        height: 100%;
        max-width: 100%;
    }
</style>
</body>
<script type="text/javascript">
    $(function(){
        tables();
    })
    function tables() {
            //执行一个 table 实例
        var table = layui.table;
        layui.use('table', function () {

            table.render({
                elem: '#demo'
                , height: 420
                , url: '/refer' //数据接口
                , page: true //开启分页
                , limit: 2
                , limits: [1, 2, 5, 10]
                , toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
                , cols: [
                    [ //表头
                    {type: 'checkbox', fixed: 'left'}
                    , {field: 'couponId', title: 'ID', width: 80, sort: true}
                    ,{field: 'couponTitle', title: '标题', width: 80}
                   , {field: 'imgUrl', title: '图片',
                        templet: function (d) {
                            return '<img  class="picurl" src="'+d.imgUrl+'"/>'
                        },width: 90}
                    , {field: 'couponTimeliness', title: '使用时效', width: 100}
                    , {field: 'couponQuantity', title: '优惠券数量', width: 110}
                    , {field: 'couponStarttime', title: '开始时间', width: 150}
                    , {field: 'couponEndtime', title: '结束时间', width: 150}
                    , {
                        field: 'couponStatus', title: '是否发放',
                        templet: function (d) {
                            if (d.couponStatus == 1) {
                                return "发放";
                            } else if (d.couponStatus == 2) {
                                return "不发放";
                            }
                        },
                        width: 200
                    }
                    , {field: 'couponType', title: '优惠券类型', width: 100}
                    , {field: 'coupon', title: '优惠券使用方式', width: 100}
                    , {field: 'couponPrice', title: '优惠券抵扣价', width: 135,totalRow: true}
                    , {fixed: 'right', width: 165, align: 'center', toolbar: '#barDemo'}
                ]
                ]
            });
        })
            //监听头工具栏事件
            table.on('toolbar(test)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id)
                    , data = checkStatus.data; //获取选中的数据
                console.log(obj.config);
                switch (obj.event) {
                    case 'add':
                        openlog()
                        break;
                };
            });

            //监听行工具事件
            table.on('tool(test)', function (obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
                var data = obj.data //获得当前行数据
                    , layEvent = obj.event; //获得 lay-event 对应的值

               if (layEvent === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        $.ajax({
                            url:"deletecoupon",
                            data:{sid:data.couponId},
                            success:function(){
                                obj.del(); //删除对应行（tr）的DOM结构
                                layer.close(index);
                                //向服务端发送删除指令
                            }
                        })
                    });
                } else if (layEvent === 'edit') {
                   openlog(data.couponId)
                }
            });
    }
    function openlog(id){
            //示范一个公告层
            layer.open({
                type: 1
                ,title: false //不显示标题栏
                ,closeBtn: false
                ,area: '500px;'
                ,shade: 0.8
                ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                ,btn: ['保存', '关闭']
                ,btnAlign: 'c'
                ,moveType: 1 //拖拽模式，0或者1
                ,content: getJspHtml("toadddiscountcoupon?id="+id)
                ,success: function(layero){
                    var btn = layero.find('.layui-layer-btn');
                    btn.find('.layui-layer-btn0').attr({
                        href: "javascript:adddiscountcoupon()"
                        ,target: '_blank'
                    });
                }
            });
    }
    //  发送ajax请求获取jsp页面内容
    function getJspHtml(url){
        var  jspHtml = "";
        $.ajax({
            url :url,// 弹框里是：  /test/project/addPage.do
            type : "post",
            async:false,//需要注意的   应是同步请求
            success : function (data){
                //返回的data为     bootstarpDialog.jsp  的页面内容
                jspHtml = data;
            },error : function (){
                layer.msg('ajax失败');
            }
        })
        //将data返回的jsp内容  填充到dialog方法的   message  属性中
        return jspHtml;
    }
    function adddiscountcoupon(){
        $.ajax({
            url:"adddiscountcoupon",
            data:$("#youhuiquanff").serialize(),
            type:"post",
            success:function(data){
                layer.msg('操作成功');
                location.reload();
            },error:function(data){
                layer.msg('操作失败');
            }
        })
    }
</script>
</html>